<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareLink Investor Demo - Real-time</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and a subtle scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling */
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto; /* Enable vertical scrolling */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* Light blue-gray */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Medium blue-gray */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Darker blue-gray on hover */
        }

        /* Basic animation for the risk level */
        @keyframes pulse-yellow {
            0%, 100% { background-color: #facc15; } /* yellow-400 */
            50% { background-color: #fbbf24; } /* yellow-500 */
        }
        @keyframes pulse-orange {
            0%, 100% { background-color: #f97316; } /* orange-500 */
            50% { background-color: #ea580c; } /* orange-600 */
        }
        @keyframes pulse-red {
            0%, 100% { background-color: #ef4444; } /* red-500 */
            50% { background-color: #dc2626; } /* red-600 */
        }

        .risk-yellow { animation: pulse-yellow 1.5s infinite; }
        .risk-orange { animation: pulse-orange 1.2s infinite; }
        .risk-red { animation: pulse-red 1s infinite; }
        .tab-button {
            @apply px-6 py-3 text-lg font-semibold rounded-t-lg transition-colors duration-200;
        }
        .tab-button.active {
            @apply bg-white text-blue-700 shadow-md;
        }
        .tab-button:not(.active) {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables accessible to the main script
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isFirebaseReady = false;

        // Ensure these global variables are defined by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase only once
                if (!window.firebaseApp) {
                    window.firebaseApp = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);

                    // Sign in with custom token if provided, otherwise anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Signed in anonymously.");
                    }

                    // Listen for auth state changes to get the current user ID
                    onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            window.currentUserId = user.uid;
                            console.log("User ID:", window.currentUserId);
                            document.getElementById('displayUserId').textContent = `Your User ID: ${window.currentUserId}`;
                        } else {
                            // User is signed out. For this demo, we ensure anonymous sign-in if no token.
                            if (!initialAuthToken) { // Only sign in anonymously if no initial token was expected
                                signInAnonymously(window.auth).then(userCredential => {
                                    window.currentUserId = userCredential.user.uid;
                                    console.log("Signed in anonymously after state change.", window.currentUserId);
                                    document.getElementById('displayUserId').textContent = `Your User ID: ${window.currentUserId}`;
                                }).catch(error => {
                                    console.error("Error signing in anonymously:", error);
                                });
                            }
                        }
                        window.isFirebaseReady = true; // Firebase is ready after auth state is determined
                        // Trigger startMonitoring or other initial functions here if needed after Firebase is ready
                        if (typeof window.startMonitoringAndListeners === 'function') {
                            window.startMonitoringAndListeners();
                        }
                    });
                }
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('displayUserId').textContent = `Firebase Error: ${error.message}`;
            }
        });
    </script>
</head>
<body class="selection:bg-indigo-300 selection:text-indigo-900">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl space-y-8 animate-fade-in-up">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">CareLink</h1>
            <p class="text-lg text-gray-600">Your AI-powered Emergency Health Companion</p>
            <p id="displayUserId" class="text-sm text-gray-500 mt-2">Loading User ID...</p>
        </header>

        <!-- Role Selector Tabs -->
        <div class="flex justify-center border-b border-gray-200 mb-8">
            <button id="patientTabBtn" class="tab-button active" onclick="switchTab('patient')">Patient View</button>
            <button id="doctorTabBtn" class="tab-button" onclick="switchTab('doctor')">Doctor View</button>
            <button id="deliveryTabBtn" class="tab-button" onclick="switchTab('delivery')">Delivery View</button>
        </div>

        <!-- Patient View Container -->
        <div id="patientView" class="tab-content">
            <!-- Current Vitals Dashboard -->
            <section class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Current Health Vitals (Patient)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <!-- Heart Rate Card -->
                    <div class="bg-white p-5 rounded-lg shadow-md transition-transform transform hover:scale-105 border border-blue-200">
                        <p class="text-sm text-gray-500 font-medium">Heart Rate</p>
                        <p id="heartRate" class="text-5xl font-extrabold text-red-600 mt-2">--</p>
                        <p class="text-sm text-gray-500">BPM</p>
                    </div>
                    <!-- Oxygen Levels Card -->
                    <div class="bg-white p-5 rounded-lg shadow-md transition-transform transform hover:scale-105 border border-blue-200">
                        <p class="text-sm text-gray-500 font-medium">Oxygen Levels</p>
                        <p id="oxygenLevels" class="text-5xl font-extrabold text-green-600 mt-2">--</p>
                        <p class="text-sm text-gray-500">% SpO2</p>
                    </div>
                    <!-- Temperature Card -->
                    <div class="bg-white p-5 rounded-lg shadow-md transition-transform transform hover:scale-105 border border-blue-200">
                        <p class="text-sm text-gray-500 font-medium">Temperature</p>
                        <p id="temperature" class="text-5xl font-extrabold text-purple-600 mt-2">--</p>
                        <p class="text-sm text-gray-500">&deg;F</p>
                    </div>
                    <!-- ECG Status Card -->
                    <div class="bg-white p-5 rounded-lg shadow-md transition-transform transform hover:scale-105 border border-blue-200">
                        <p class="text-sm text-gray-500 font-medium">ECG Status</p>
                        <p id="ecgStatus" class="text-5xl font-extrabold text-blue-600 mt-2">Normal</p>
                        <p class="text-sm text-gray-500">Rhythm</p>
                    </div>
                </div>
                <!-- Risk Level Indicator -->
                <div id="riskLevelContainer" class="mt-8 p-4 rounded-lg text-center shadow-lg transition-all duration-500 ease-in-out border border-transparent">
                    <p class="text-xl font-bold text-white"><span id="riskLevelText">Analyzing...</span> Risk Level</p>
                </div>
            </section>

            <!-- Emergency Response Flow Simulation (Patient View) -->
            <section class="bg-gradient-to-br from-pink-50 to-red-100 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Emergency Response Flow (Patient)</h2>
                <div class="space-y-6">
                    <!-- Step 1: Alert Triggered -->
                    <div class="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-md border border-red-200">
                        <span class="text-red-500 text-3xl">🚨</span>
                        <div>
                            <p class="font-semibold text-lg text-gray-800">1. AI Alert Triggered</p>
                            <p id="patientAlertMessage" class="text-gray-600">No active alerts.</p>
                        </div>
                    </div>

                    <!-- Step 2: Doctor Verification -->
                    <div class="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-md border border-yellow-200">
                        <span class="text-yellow-500 text-3xl">👨‍⚕️</span>
                        <div>
                            <p class="font-semibold text-lg text-gray-800">2. Doctor Verification</p>
                            <p id="patientDoctorStatus" class="text-gray-600">Waiting for AI alert to trigger doctor review.</p>
                            <p id="assignedDoctor" class="text-sm text-gray-500 mt-1 hidden">Assigned Doctor: <span id="assignedDoctorName">N/A</span></p>
                        </div>
                    </div>

                    <!-- Step 3: Treatment Dispatch / Medicine Order -->
                    <div class="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-md border border-green-200">
                        <span class="text-green-500 text-3xl">🚑</span>
                        <div>
                            <p class="font-semibold text-lg text-gray-800">3. Treatment Delivery</p>
                            <p id="patientDeliveryStatus" class="text-gray-600">Awaiting doctor verification for dispatch/order.</p>
                            <div id="patientLogisticsInfo" class="mt-3 text-sm text-gray-700 hidden">
                                <p id="patientDispatchDetails"></p>
                                <p id="assignedDelivery" class="mt-1">Delivery Person: <span id="assignedDeliveryName">N/A</span></p>
                                <div id="patientMapPlaceholder" class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center mt-2 text-gray-500 border border-dashed border-gray-300">
                                    Simulated Geo-Based Tracking
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons for Patient -->
                <div class="text-center mt-8 space-x-4">
                    <button id="simulateCrisisBtn" class="bg-red-600 text-white px-8 py-3 rounded-full shadow-lg hover:bg-red-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                        Simulate Medical Crisis
                    </button>
                    <button id="resetPatientBtn" class="bg-gray-700 text-white px-8 py-3 rounded-full shadow-lg hover:bg-gray-800 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                        Reset Patient Data
                    </button>
                </div>
            </section>
        </div>

        <!-- Doctor View Container -->
        <div id="doctorView" class="tab-content hidden">
            <section class="bg-gradient-to-br from-green-50 to-blue-100 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Doctor Dashboard</h2>
                <div id="doctorAlertsContainer" class="space-y-4">
                    <p id="noDoctorAlerts" class="text-center text-gray-600">No pending alerts for verification.</p>
                    <!-- Alerts will be dynamically loaded here -->
                </div>
                <div class="text-center mt-8">
                    <button id="resetDoctorBtn" class="bg-gray-700 text-white px-8 py-3 rounded-full shadow-lg hover:bg-gray-800 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                        Reset Doctor Alerts
                    </button>
                </div>
            </section>
        </div>

        <!-- Delivery View Container -->
        <div id="deliveryView" class="tab-content hidden">
            <section class="bg-gradient-to-br from-purple-50 to-indigo-100 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Delivery Dashboard</h2>
                <div id="deliveryOrdersContainer" class="space-y-4">
                    <p id="noDeliveryOrders" class="text-center text-gray-600">No active delivery orders.</p>
                    <!-- Delivery orders will be dynamically loaded here -->
                </div>
                <div class="text-center mt-8">
                    <button id="resetDeliveryBtn" class="bg-gray-700 text-white px-8 py-3 rounded-full shadow-lg hover:bg-gray-800 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                        Reset Delivery Orders
                    </button>
                </div>
            </section>
        </div>

        <!-- Key Features Overview (from PRD) - Remains the same -->
        <section class="p-6 rounded-xl shadow-lg bg-white border border-gray-200">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">CareLink Differentiators</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">⚡</span>
                    <div>
                        <p class="font-semibold text-gray-800">Continuous AI Vitals Monitoring</p>
                        <p class="text-gray-600 text-sm">Real-time tracking for proactive alerts.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">📊</span>
                    <div>
                        <p class="font-semibold text-gray-800">AI Risk Grading (Yellow, Orange, Red)</p>
                        <p class="text-gray-600 text-sm">Instant triage based on severity.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">✅</span>
                    <div>
                        <p class="font-semibold text-gray-800">Doctor Verification Before Treatment</p>
                        <p class="text-gray-600 text-sm">Ensuring accurate and validated responses.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">📍</span>
                    <div>
                        <p class="font-semibold text-gray-800">Geo-Based Freelance Doctor Dispatch</p>
                        <p class="text-gray-600 text-sm">Optimized for rapid response times.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">💊</span>
                    <div>
                        <p class="font-semibold text-gray-800">Medicine Delivery Integration</p>
                        <p class="text-gray-600 text-sm">Linked to verified prescriptions.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-indigo-500 text-2xl">🔒</span>
                    <div>
                        <p class="font-semibold text-gray-800">Hybrid Edge + Cloud AI for Privacy</p>
                        <p class="text-gray-600 text-sm">Processing data securely on-device.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer for copyright or additional info -->
        <footer class="text-center text-gray-500 text-sm mt-8">
            <p>&copy; 2025 CareLink. All rights reserved. (Demo Build with Real-time Simulation)</p>
        </footer>
    </div>

    <script type="module">
        // Import necessary Firestore functions
        import { doc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables from Firebase initialization script
        let db;
        let auth;
        let currentUserId;
        let isFirebaseReady = false;
        let vitalsInterval;
        let currentRisk = 'Green';
        let activeAlertDocId = null; // Stores the ID of the current active alert in Firestore

        // Role-specific variables
        let currentRole = 'patient';
        const dummyDoctorId = "doctor123"; // A fixed ID for our simulated doctor
        const dummyDeliveryBoyId = "delivery456"; // A fixed ID for our simulated delivery boy

        // --- DOM Elements ---
        const heartRateElem = document.getElementById('heartRate');
        const oxygenLevelsElem = document.getElementById('oxygenLevels');
        const temperatureElem = document.getElementById('temperature');
        const ecgStatusElem = document.getElementById('ecgStatus');
        const riskLevelContainer = document.getElementById('riskLevelContainer');
        const riskLevelText = document.getElementById('riskLevelText');

        // Patient View Elements
        const patientView = document.getElementById('patientView');
        const patientAlertMessageElem = document.getElementById('patientAlertMessage');
        const patientDoctorStatusElem = document.getElementById('patientDoctorStatus');
        const assignedDoctorElem = document.getElementById('assignedDoctor');
        const assignedDoctorNameElem = document.getElementById('assignedDoctorName');
        const patientDeliveryStatusElem = document.getElementById('patientDeliveryStatus');
        const patientLogisticsInfo = document.getElementById('patientLogisticsInfo');
        const patientDispatchDetailsElem = document.getElementById('patientDispatchDetails');
        const assignedDeliveryElem = document.getElementById('assignedDelivery');
        const assignedDeliveryNameElem = document.getElementById('assignedDeliveryName');
        const simulateCrisisBtn = document.getElementById('simulateCrisisBtn');
        const resetPatientBtn = document.getElementById('resetPatientBtn');

        // Doctor View Elements
        const doctorView = document.getElementById('doctorView');
        const doctorAlertsContainer = document.getElementById('doctorAlertsContainer');
        const noDoctorAlertsElem = document.getElementById('noDoctorAlerts');
        const resetDoctorBtn = document.getElementById('resetDoctorBtn');

        // Delivery View Elements
        const deliveryView = document.getElementById('deliveryView');
        const deliveryOrdersContainer = document.getElementById('deliveryOrdersContainer');
        const noDeliveryOrdersElem = document.getElementById('noDeliveryOrders');
        const resetDeliveryBtn = document.getElementById('resetDeliveryBtn');

        // Tab Buttons
        const patientTabBtn = document.getElementById('patientTabBtn');
        const doctorTabBtn = document.getElementById('doctorTabBtn');
        const deliveryTabBtn = document.getElementById('deliveryTabBtn');

        // Expose startMonitoringAndListeners to global scope after Firebase init
        window.startMonitoringAndListeners = async () => {
            db = window.db;
            auth = window.auth;
            currentUserId = window.currentUserId;
            isFirebaseReady = window.isFirebaseReady;

            if (db && currentUserId) {
                console.log("Firebase DB and User ID are ready. Starting monitoring and listeners.");
                // Initialize user roles in Firestore (if not exists)
                await ensureUserRoleExists(currentUserId, 'patient'); // This user is primarily a patient
                await ensureUserRoleExists(dummyDoctorId, 'doctor');
                await ensureUserRoleExists(dummyDeliveryBoyId, 'delivery');

                startMonitoring();
                setupPatientListeners();
                setupDoctorListeners();
                setupDeliveryListeners();
            } else {
                console.warn("Firebase not ready yet, retrying in 500ms...");
                setTimeout(window.startMonitoringAndListeners, 500); // Retry until ready
            }
        };

        /**
         * Ensures a user entry exists in the 'users' collection for the given userId and role.
         * This simplifies assigning roles in the demo.
         * @param {string} userId - The ID of the user.
         * @param {string} role - The role of the user ('patient', 'doctor', 'delivery').
         */
        async function ensureUserRoleExists(userId, role) {
            if (!db) return;
            const userRef = doc(db, `artifacts/${__app_id}/public/data/users`, userId);
            try {
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        role: role,
                        name: role === 'patient' ? `Patient_${userId.substring(0, 8)}` : (role === 'doctor' ? 'Dr. AI-Care' : 'Delivery Link'),
                        status: 'available', // e.g., 'available', 'busy', 'offline'
                        assignedAlertId: null
                    });
                    console.log(`Created user ${userId} with role ${role}`);
                }
            } catch (e) {
                console.error("Error ensuring user role exists: ", e);
            }
        }

        /**
         * Handles switching between Patient, Doctor, and Delivery views.
         * @param {string} role - The role to switch to ('patient', 'doctor', 'delivery').
         */
        function switchTab(role) {
            currentRole = role;
            patientView.classList.add('hidden');
            doctorView.classList.add('hidden');
            deliveryView.classList.add('hidden');

            patientTabBtn.classList.remove('active');
            doctorTabBtn.classList.remove('active');
            deliveryTabBtn.classList.remove('active');

            if (role === 'patient') {
                patientView.classList.remove('hidden');
                patientTabBtn.classList.add('active');
            } else if (role === 'doctor') {
                doctorView.classList.remove('hidden');
                doctorTabBtn.classList.add('active');
            } else if (role === 'delivery') {
                deliveryView.classList.remove('hidden');
                deliveryTabBtn.classList.add('active');
            }
        }

        // --- Utility Functions ---

        /**
         * Generates a random integer within a specified range.
         * @param {number} min - The minimum value (inclusive).
         * @param {number} max - The maximum value (inclusive).
         * @returns {number} A random integer.
         */
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Simulates fluctuating vital signs, with an option to force a crisis.
         * @param {boolean} forceCrisis - If true, guarantees a Red alert scenario.
         * @returns {object} An object containing simulated vital signs.
         */
        function generateVitals(forceCrisis = false) {
            let hr, spo2, temp, ecg;

            if (forceCrisis) {
                hr = getRandomInt(120, 160); // High HR
                spo2 = getRandomInt(80, 88); // Low SpO2
                temp = getRandomInt(101, 104); // High Temp
                ecg = 'Irregular';
            } else {
                const chance = Math.random();
                if (chance < 0.02) { // 2% chance of Red alert scenario (even without forceCrisis)
                    hr = getRandomInt(120, 160);
                    spo2 = getRandomInt(80, 88);
                    temp = getRandomInt(101, 104);
                    ecg = 'Irregular';
                } else if (chance < 0.07) { // 5% chance of Orange alert scenario
                    hr = getRandomInt(95, 110);
                    spo2 = getRandomInt(89, 93);
                    temp = getRandomInt(99, 100);
                    ecg = 'Abnormal';
                } else { // Remaining chance of Normal/Yellow scenario
                    hr = getRandomInt(60, 90);
                    spo2 = getRandomInt(94, 99);
                    temp = getRandomInt(97, 98);
                    ecg = 'Normal';

                    if (Math.random() < 0.1) { // 10% chance to slightly vary for yellow within normal bounds
                        hr = getRandomInt(91, 94);
                        spo2 = getRandomInt(90, 93);
                        temp = getRandomInt(98, 99);
                        ecg = Math.random() < 0.5 ? 'Normal' : 'Minor Irregularity';
                    }
                }
            }

            return {
                heartRate: hr,
                oxygenLevels: spo2,
                temperature: temp,
                ecgStatus: ecg,
                timestamp: new Date()
            };
        }

        /**
         * Updates the UI with the latest vital signs and pushes to Firestore.
         * @param {object} vitals - The vital signs object.
         */
        async function updateVitalsAndFirestore(vitals) {
            if (!db || !currentUserId) return;

            heartRateElem.textContent = vitals.heartRate;
            oxygenLevelsElem.textContent = vitals.oxygenLevels;
            temperatureElem.textContent = vitals.temperature;
            ecgStatusElem.textContent = vitals.ecgStatus;

            try {
                // Update patient's vitals document in Firestore
                const patientVitalsRef = doc(db, `artifacts/${__app_id}/public/data/patients`, currentUserId);
                await setDoc(patientVitalsRef, { vitals: vitals }, { merge: true });
            } catch (e) {
                console.error("Error updating vitals in Firestore: ", e);
            }
            checkRiskLevel(vitals);
        }

        /**
         * Determines the risk level based on vital signs and updates the UI and Firestore alert status.
         * This simulates the "Edge AI Analysis" and subsequent cloud interaction.
         * @param {object} vitals - The vital signs object.
         */
        async function checkRiskLevel(vitals) {
            let newRisk = 'Green';

            if (vitals.heartRate > 115 || vitals.oxygenLevels < 89 || vitals.temperature > 100.5 || vitals.ecgStatus === 'Irregular') {
                newRisk = 'Red';
            } else if (vitals.heartRate > 95 || vitals.oxygenLevels < 93 || vitals.temperature > 99.5 || vitals.ecgStatus === 'Abnormal') {
                newRisk = 'Orange';
            } else if (vitals.heartRate > 90 || vitals.oxygenLevels < 95 || vitals.temperature > 98.6 || vitals.ecgStatus === 'Minor Irregularity') {
                newRisk = 'Yellow';
            }

            // Update UI only if risk level changes or if it's the first check
            if (newRisk !== currentRisk || !riskLevelContainer.classList.length) {
                currentRisk = newRisk;
                riskLevelContainer.className = 'mt-8 p-4 rounded-lg text-center shadow-lg transition-all duration-500 ease-in-out border border-transparent';

                let bgColorClass = 'bg-gray-400';
                let animationClass = '';
                let borderColorClass = '';
                let textColor = 'text-white';

                switch (currentRisk) {
                    case 'Red':
                        bgColorClass = 'bg-red-500';
                        animationClass = 'risk-red';
                        borderColorClass = 'border-red-600';
                        break;
                    case 'Orange':
                        bgColorClass = 'bg-orange-500';
                        animationClass = 'risk-orange';
                        borderColorClass = 'border-orange-600';
                        break;
                    case 'Yellow':
                        bgColorClass = 'bg-yellow-400';
                        animationClass = 'risk-yellow';
                        borderColorClass = 'border-yellow-500';
                        textColor = 'text-gray-900'; // Yellow needs dark text
                        break;
                    case 'Green':
                    default:
                        bgColorClass = 'bg-green-500';
                        borderColorClass = 'border-green-600';
                        break;
                }

                riskLevelContainer.classList.add(bgColorClass, animationClass, borderColorClass);
                riskLevelText.textContent = currentRisk;
                riskLevelText.classList.remove('text-white', 'text-gray-900');
                riskLevelText.classList.add(textColor);

                // Trigger alert in Firestore if risk is Yellow, Orange, or Red AND no active alert exists
                if ((currentRisk === 'Red' || currentRisk === 'Orange' || currentRisk === 'Yellow') && !activeAlertDocId) {
                    await createAlert(currentRisk, vitals);
                } else if (currentRisk === 'Green' && activeAlertDocId) {
                    // If vitals return to normal and there's an active alert, assume it's resolved or dismissed
                    // For a full system, doctor would explicitly dismiss. Here, we can auto-resolve simple yellow.
                    const alertRef = doc(db, `artifacts/${__app_id}/public/data/alerts`, activeAlertDocId);
                    const alertSnap = await getDoc(alertRef);
                    if (alertSnap.exists() && alertSnap.data().status === 'pending') {
                         await updateDoc(alertRef, { status: 'auto_resolved', verificationNotes: 'Patient vitals returned to normal.' });
                    }
                }
            }
        }

        /**
         * Creates a new alert document in Firestore.
         * @param {string} level - The risk level.
         * @param {object} vitals - The vitals at the time of alert.
         */
        async function createAlert(level, vitals) {
            if (!db || !currentUserId || activeAlertDocId) return; // Prevent multiple alerts

            try {
                const alertsCollection = collection(db, `artifacts/${__app_id}/public/data/alerts`);
                const newAlertRef = await addDoc(alertsCollection, {
                    patientId: currentUserId,
                    riskLevel: level,
                    status: 'pending', // pending, verified, dismissed, dispatched, delivered, auto_resolved
                    vitalsAtAlert: vitals,
                    timestamp: new Date(),
                    doctorAssigned: null,
                    deliveryBoyAssigned: null,
                    verificationNotes: null,
                    dispatchEta: null,
                    treatmentType: null // 'doctor_dispatch', 'medicine_order'
                });
                activeAlertDocId = newAlertRef.id;
                console.log("New alert created:", activeAlertDocId);

                // Update patient's status to reflect active alert
                const patientRef = doc(db, `artifacts/${__app_id}/public/data/patients`, currentUserId);
                await updateDoc(patientRef, { currentAlertId: activeAlertDocId });

            } catch (e) {
                console.error("Error creating alert: ", e);
            }
        }

        /**
         * Simulates a medical crisis (forces Red alert vitals).
         */
        async function simulateMedicalCrisis() {
            if (!db || !currentUserId) return;
            // Stop current random monitoring to allow crisis to be stable
            clearInterval(vitalsInterval);

            // Force a red alert
            const crisisVitals = generateVitals(true);
            await updateVitalsAndFirestore(crisisVitals);

            // Re-enable monitoring after a short delay if no alert was triggered (should be triggered now)
            if (!activeAlertDocId) {
                 // If for some reason an alert wasn't created, restart random
                vitalsInterval = setInterval(() => {
                    if (!activeAlertDocId) { // Only generate if no active crisis
                        updateVitalsAndFirestore(generateVitals());
                    }
                }, 3000);
            }
        }

        /**
         * Sets up real-time listeners for the patient's data.
         */
        function setupPatientListeners() {
            if (!db || !currentUserId) {
                console.warn("Patient listener setup deferred: DB or UserID not ready.");
                return;
            }

            // Listen for patient vitals updates
            const patientVitalsRef = doc(db, `artifacts/${__app_id}/public/data/patients`, currentUserId);
            onSnapshot(patientVitalsRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().vitals) {
                    const vitals = docSnap.data().vitals;
                    heartRateElem.textContent = vitals.heartRate;
                    oxygenLevelsElem.textContent = vitals.oxygenLevels;
                    temperatureElem.textContent = vitals.temperature;
                    ecgStatusElem.textContent = vitals.ecgStatus;
                    // Re-check risk level to update UI animations/colors
                    checkRiskLevel(vitals);
                    activeAlertDocId = docSnap.data().currentAlertId || null;
                }
            }, (error) => {
                console.error("Error listening to patient vitals: ", error);
            });

            // Listen for changes to the patient's active alert
            onSnapshot(query(collection(db, `artifacts/${__app_id}/public/data/alerts`), where("patientId", "==", currentUserId)), (snapshot) => {
                let alert = null;
                snapshot.forEach(doc => {
                    // Assuming only one active alert per patient for simplicity
                    const data = doc.data();
                    if (data.status === 'pending' || data.status === 'verified' || data.status === 'dispatched' || data.status === 'on_the_way') {
                        alert = { id: doc.id, ...data };
                        activeAlertDocId = doc.id;
                    }
                });

                if (alert) {
                    patientAlertMessageElem.textContent = `Alert Triggered: ${alert.riskLevel} - ${alert.vitalsAtAlert.ecgStatus} ECG`;
                    patientAlertMessageElem.classList.add('font-bold', alert.riskLevel === 'Red' ? 'text-red-700' : 'text-orange-700');

                    if (alert.status === 'pending') {
                        patientDoctorStatusElem.textContent = 'Waiting for doctor verification.';
                        assignedDoctorElem.classList.add('hidden');
                        patientLogisticsInfo.classList.add('hidden');
                    } else if (alert.status === 'verified') {
                        patientDoctorStatusElem.textContent = 'Doctor has VERIFIED the emergency!';
                        patientDoctorStatusElem.classList.add('font-bold', 'text-blue-700');
                        assignedDoctorElem.classList.remove('hidden');
                        assignedDoctorNameElem.textContent = alert.doctorAssigned || 'N/A';
                        patientLogisticsInfo.classList.remove('hidden');
                        patientDeliveryStatusElem.textContent = 'Treatment being prepared for dispatch/order.';
                        patientDispatchDetailsElem.textContent = alert.treatmentType === 'doctor_dispatch' ? 'Awaiting nearest doctor dispatch.' : 'Medicine order being placed.';
                    } else if (alert.status === 'dismissed' || alert.status === 'auto_resolved') {
                        patientAlertMessageElem.textContent = `Alert ${alert.status === 'dismissed' ? 'Dismissed' : 'Auto-Resolved'}.`;
                        patientDoctorStatusElem.textContent = `Doctor ${alert.status === 'dismissed' ? 'dismissed' : 'auto-resolved'} alert.`;
                        patientDeliveryStatusElem.textContent = 'No treatment needed at this time.';
                        assignedDoctorElem.classList.add('hidden');
                        patientLogisticsInfo.classList.add('hidden');
                        activeAlertDocId = null; // Clear active alert
                        startMonitoring(); // Resume normal vital updates
                    } else if (alert.status === 'dispatched') {
                        patientDeliveryStatusElem.textContent = 'Urgent medical dispatch initiated!';
                        patientDeliveryStatusElem.classList.add('font-bold', 'text-red-700');
                        patientLogisticsInfo.classList.remove('hidden');
                        patientDispatchDetailsElem.textContent = `⚡ Dispatching ${alert.doctorAssigned} to your location. ETA: ${alert.dispatchEta} minutes.`;
                        assignedDeliveryElem.classList.remove('hidden');
                        assignedDeliveryNameElem.textContent = alert.deliveryBoyAssigned || 'N/A';
                    } else if (alert.status === 'on_the_way') {
                         patientDeliveryStatusElem.textContent = `Delivery ${alert.treatmentType === 'doctor_dispatch' ? 'Doctor' : 'Medicine'} is on the way!`;
                         patientLogisticsInfo.classList.remove('hidden');
                         patientDispatchDetailsElem.textContent = `🚚 ${alert.deliveryBoyAssigned} is on the way. ETA: ${alert.dispatchEta} minutes.`;
                         assignedDeliveryElem.classList.remove('hidden');
                         assignedDeliveryNameElem.textContent = alert.deliveryBoyAssigned || 'N/A';
                    } else if (alert.status === 'delivered') {
                        patientDeliveryStatusElem.textContent = 'Treatment delivered!';
                        patientDeliveryStatusElem.classList.add('font-bold', 'text-green-700');
                        patientDispatchDetailsElem.textContent = `✅ Your ${alert.treatmentType === 'doctor_dispatch' ? 'doctor' : 'medicine'} has arrived.`;
                        assignedDeliveryElem.classList.remove('hidden');
                        assignedDeliveryNameElem.textContent = alert.deliveryBoyAssigned || 'N/A';
                        activeAlertDocId = null; // Clear active alert
                        startMonitoring(); // Resume normal vital updates
                    }
                } else {
                    // No active alerts for this patient
                    patientAlertMessageElem.textContent = 'No active alerts.';
                    patientAlertMessageElem.classList.remove('font-bold', 'text-red-700', 'text-orange-700');
                    patientDoctorStatusElem.textContent = 'Waiting for AI alert to trigger doctor review.';
                    assignedDoctorElem.classList.add('hidden');
                    patientDeliveryStatusElem.textContent = 'Awaiting doctor verification for dispatch/order.';
                    patientLogisticsInfo.classList.add('hidden');
                    activeAlertDocId = null;
                }
            }, (error) => {
                console.error("Error listening to patient alerts: ", error);
            });
        }

        /**
         * Sets up real-time listeners for the doctor's data.
         */
        function setupDoctorListeners() {
            if (!db) return;

            // Listen for alerts with status 'pending'
            const q = query(collection(db, `artifacts/${__app_id}/public/data/alerts`), where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                let pendingAlerts = [];
                snapshot.forEach((doc) => {
                    pendingAlerts.push({ id: doc.id, ...doc.data() });
                });
                renderDoctorAlerts(pendingAlerts);
            }, (error) => {
                console.error("Error listening to doctor alerts: ", error);
            });
        }

        /**
         * Renders the alerts in the Doctor's dashboard.
         * @param {Array<object>} alerts - An array of alert objects.
         */
        function renderDoctorAlerts(alerts) {
            doctorAlertsContainer.innerHTML = ''; // Clear previous alerts
            if (alerts.length === 0) {
                doctorAlertsContainer.appendChild(noDoctorAlertsElem);
                noDoctorAlertsElem.classList.remove('hidden');
            } else {
                noDoctorAlertsElem.classList.add('hidden');
                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    alertDiv.innerHTML = `
                        <p class="font-bold text-lg text-gray-800">Alert for Patient: ${alert.patientId.substring(0, 8)}...</p>
                        <p class="text-gray-600">Risk Level: <span class="font-semibold ${alert.riskLevel === 'Red' ? 'text-red-500' : (alert.riskLevel === 'Orange' ? 'text-orange-500' : 'text-yellow-500')}">${alert.riskLevel}</span></p>
                        <p class="text-gray-600">Vitals: HR ${alert.vitalsAtAlert.heartRate}, SpO2 ${alert.vitalsAtAlert.oxygenLevels}, Temp ${alert.vitalsAtAlert.temperature}&deg;F, ECG ${alert.vitalsAtAlert.ecgStatus}</p>
                        <div class="mt-3 space-x-2">
                            <button data-alert-id="${alert.id}" class="doctor-verify-btn bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200">Verify & Dispatch</button>
                            <button data-alert-id="${alert.id}" class="doctor-medicine-btn bg-purple-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-all duration-200">Verify & Order Medicine</button>
                            <button data-alert-id="${alert.id}" class="doctor-dismiss-btn bg-gray-400 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-500 transition-all duration-200">Dismiss</button>
                        </div>
                    `;
                    doctorAlertsContainer.appendChild(alertDiv);
                });

                // Add event listeners to the new buttons
                doctorAlertsContainer.querySelectorAll('.doctor-verify-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => simulateDoctorAction(e.target.dataset.alertId, 'verify_dispatch'));
                });
                 doctorAlertsContainer.querySelectorAll('.doctor-medicine-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => simulateDoctorAction(e.target.dataset.alertId, 'verify_medicine'));
                });
                doctorAlertsContainer.querySelectorAll('.doctor-dismiss-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => simulateDoctorAction(e.target.dataset.alertId, 'dismiss'));
                });
            }
        }

        /**
         * Simulates a doctor taking action on an alert (verify/dismiss).
         * @param {string} alertId - The ID of the alert document.
         * @param {string} action - The action to take ('verify_dispatch', 'verify_medicine', 'dismiss').
         */
        async function simulateDoctorAction(alertId, action) {
            if (!db) return;
            const alertRef = doc(db, `artifacts/${__app_id}/public/data/alerts`, alertId);
            const doctorUserRef = doc(db, `artifacts/${__app_id}/public/data/users`, dummyDoctorId);

            try {
                if (action === 'verify_dispatch') {
                    await updateDoc(alertRef, {
                        status: 'verified', // Doctor has verified, now ready for dispatch decision
                        doctorAssigned: dummyDoctorId, // Assign the dummy doctor
                        verificationNotes: 'Doctor verified urgent medical emergency.',
                        treatmentType: 'doctor_dispatch'
                    });
                     await updateDoc(doctorUserRef, { status: 'busy', assignedAlertId: alertId });
                     // Immediately proceed to dispatch
                     await assignDeliveryForTreatment(alertId, 'doctor_dispatch');
                } else if (action === 'verify_medicine') {
                    await updateDoc(alertRef, {
                        status: 'verified', // Doctor has verified, now ready for medicine order
                        doctorAssigned: dummyDoctorId,
                        verificationNotes: 'Doctor verified medical need, recommending medicine.',
                        treatmentType: 'medicine_order'
                    });
                     await updateDoc(doctorUserRef, { status: 'busy', assignedAlertId: alertId });
                     // Immediately proceed to medicine delivery assignment
                     await assignDeliveryForTreatment(alertId, 'medicine_order');
                } else if (action === 'dismiss') {
                    await updateDoc(alertRef, {
                        status: 'dismissed',
                        doctorAssigned: dummyDoctorId,
                        verificationNotes: 'Doctor reviewed and dismissed as non-emergency/false alarm.',
                        assignedAlertId: null
                    });
                    await updateDoc(doctorUserRef, { status: 'available', assignedAlertId: null });
                }
                console.log(`Doctor action '${action}' for alert ${alertId} completed.`);
            } catch (e) {
                console.error(`Error performing doctor action '${action}' for alert ${alertId}: `, e);
            }
        }

        /**
         * Assigns a delivery boy for a verified alert.
         * In a real app, this would involve matching algorithms. Here, we just assign the dummy.
         * @param {string} alertId - The ID of the alert.
         * @param {string} treatmentType - 'doctor_dispatch' or 'medicine_order'.
         */
        async function assignDeliveryForTreatment(alertId, treatmentType) {
            if (!db) return;
            const alertRef = doc(db, `artifacts/${__app_id}/public/data/alerts`, alertId);
            const deliveryUserRef = doc(db, `artifacts/${__app_id}/public/data/users`, dummyDeliveryBoyId);

            try {
                await updateDoc(alertRef, {
                    status: 'dispatched', // Or 'awaiting_delivery_pickup'
                    deliveryBoyAssigned: dummyDeliveryBoyId,
                    dispatchEta: getRandomInt(5, 60), // Random ETA
                    treatmentType: treatmentType
                });
                await updateDoc(deliveryUserRef, { status: 'busy', assignedAlertId: alertId });
                console.log(`Delivery assigned for alert ${alertId}.`);
            } catch (e) {
                console.error("Error assigning delivery: ", e);
            }
        }

        /**
         * Sets up real-time listeners for the delivery boy's data.
         */
        function setupDeliveryListeners() {
            if (!db) return;

            // Listen for alerts where this delivery boy is assigned
            const q = query(collection(db, `artifacts/${__app_id}/public/data/alerts`), where("deliveryBoyAssigned", "==", dummyDeliveryBoyId), where("status", "in", ["dispatched", "on_the_way"]));
            onSnapshot(q, (snapshot) => {
                let activeOrders = [];
                snapshot.forEach((doc) => {
                    activeOrders.push({ id: doc.id, ...doc.data() });
                });
                renderDeliveryOrders(activeOrders);
            }, (error) => {
                console.error("Error listening to delivery orders: ", error);
            });
        }

        /**
         * Renders the delivery orders in the Delivery Dashboard.
         * @param {Array<object>} orders - An array of order objects (alerts).
         */
        function renderDeliveryOrders(orders) {
            deliveryOrdersContainer.innerHTML = ''; // Clear previous orders
            if (orders.length === 0) {
                deliveryOrdersContainer.appendChild(noDeliveryOrdersElem);
                noDeliveryOrdersElem.classList.remove('hidden');
            } else {
                noDeliveryOrdersElem.classList.add('hidden');
                orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    orderDiv.innerHTML = `
                        <p class="font-bold text-lg text-gray-800">Order for Patient: ${order.patientId.substring(0, 8)}...</p>
                        <p class="text-gray-600">Type: <span class="font-semibold">${order.treatmentType === 'doctor_dispatch' ? 'Doctor Dispatch' : 'Medicine Delivery'}</span></p>
                        <p class="text-gray-600">Status: <span class="font-semibold text-blue-500">${order.status.replace(/_/g, ' ')}</span></p>
                        <p class="text-gray-600">ETA: ${order.dispatchEta} minutes</p>
                        <div class="mt-3 space-x-2">
                            <button data-order-id="${order.id}" class="delivery-pickup-btn bg-orange-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-orange-700 transition-all duration-200 ${order.status === 'on_the_way' ? 'opacity-50 cursor-not-allowed' : ''}" ${order.status === 'on_the_way' ? 'disabled' : ''}>
                                ${order.status === 'dispatched' ? 'Pick Up/Start Delivery' : 'On The Way'}
                            </button>
                            <button data-order-id="${order.id}" class="delivery-complete-btn bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 ${order.status !== 'on_the_way' ? 'opacity-50 cursor-not-allowed' : ''}" ${order.status !== 'on_the_way' ? 'disabled' : ''}>
                                Mark as Delivered
                            </button>
                        </div>
                    `;
                    deliveryOrdersContainer.appendChild(orderDiv);
                });

                // Add event listeners to the new buttons
                deliveryOrdersContainer.querySelectorAll('.delivery-pickup-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => simulateDeliveryAction(e.target.dataset.orderId, 'pickup'));
                });
                deliveryOrdersContainer.querySelectorAll('.delivery-complete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => simulateDeliveryAction(e.target.dataset.orderId, 'complete'));
                });
            }
        }

        /**
         * Simulates a delivery boy taking action on an order.
         * @param {string} orderId - The ID of the order (alert document).
         * @param {string} action - The action to take ('pickup', 'complete').
         */
        async function simulateDeliveryAction(orderId, action) {
            if (!db) return;
            const alertRef = doc(db, `artifacts/${__app_id}/public/data/alerts`, orderId);
            const deliveryUserRef = doc(db, `artifacts/${__app_id}/public/data/users`, dummyDeliveryBoyId);
            const patientRef = doc(db, `artifacts/${__app_id}/public/data/patients`, (await getDoc(alertRef)).data().patientId);

            try {
                if (action === 'pickup') {
                    await updateDoc(alertRef, { status: 'on_the_way' });
                    console.log(`Delivery for ${orderId} is now on the way.`);
                } else if (action === 'complete') {
                    await updateDoc(alertRef, { status: 'delivered' });
                    await updateDoc(deliveryUserRef, { status: 'available', assignedAlertId: null });
                    await updateDoc(patientRef, { currentAlertId: null }); // Clear patient's active alert
                    activeAlertDocId = null; // Clear local state for patient
                    console.log(`Delivery for ${orderId} marked as delivered.`);
                }
            } catch (e) {
                console.error(`Error performing delivery action '${action}' for order ${orderId}: `, e);
            }
        }

        /**
         * Resets the entire simulation to its initial state by clearing Firestore data.
         * Note: In a real app, this would involve careful data management and authorization.
         * For this demo, it resets the primary patient, doctor, and delivery data.
         */
        async function resetSimulation() {
            if (!db || !currentUserId) return;
            clearInterval(vitalsInterval); // Stop current monitoring

            try {
                // Delete patient's current alert if any
                if (activeAlertDocId) {
                    await updateDoc(doc(db, `artifacts/${__app_id}/public/data/alerts`, activeAlertDocId), { status: 'reset_by_user' });
                    activeAlertDocId = null;
                }
                // Reset patient's current alert reference
                await updateDoc(doc(db, `artifacts/${__app_id}/public/data/patients`, currentUserId), { vitals: generateVitals(), currentAlertId: null });

                // Reset doctor status
                await updateDoc(doc(db, `artifacts/${__app_id}/public/data/users`, dummyDoctorId), { status: 'available', assignedAlertId: null });

                // Reset delivery boy status
                await updateDoc(doc(db, `artifacts/${__app_id}/public/data/users`, dummyDeliveryBoyId), { status: 'available', assignedAlertId: null });

                console.log("Simulation data reset in Firestore.");
                // After resetting, restart monitoring to get fresh data
                startMonitoring();
                switchTab('patient'); // Go back to patient view
            } catch (e) {
                console.error("Error resetting simulation: ", e);
            }
        }

        /**
         * Starts the continuous vital monitoring simulation.
         */
        function startMonitoring() {
            // Clear any existing interval to prevent duplicates
            clearInterval(vitalsInterval);

            // Initial update
            updateVitalsAndFirestore(generateVitals());

            // Set interval for continuous updates
            vitalsInterval = setInterval(() => {
                // Continue generating random vitals only if there is no active alert that requires intervention
                // or if the alert has been handled (dismissed/delivered)
                if (!activeAlertDocId) {
                     updateVitalsAndFirestore(generateVitals());
                } else {
                    // When there's an active alert, vitals stay constant at crisis level until resolved
                    // This creates a stable "crisis" for doctor/delivery to act upon
                    // The vitals displayed will be those from the activeAlertDocId's vitalsAtAlert
                    const alertRef = doc(db, `artifacts/${__app_id}/public/data/alerts`, activeAlertDocId);
                    getDoc(alertRef).then(snap => {
                        if (snap.exists() && snap.data().vitalsAtAlert) {
                            updateVitalsDisplayOnly(snap.data().vitalsAtAlert); // Update UI without pushing to Firestore
                        }
                    });
                }
            }, 3000); // Update every 3 seconds
        }

        /**
         * Updates UI with vitals without pushing to Firestore.
         * Used when an alert is active and vitals are stable at crisis level.
         * @param {object} vitals - The vital signs object.
         */
        function updateVitalsDisplayOnly(vitals) {
            heartRateElem.textContent = vitals.heartRate;
            oxygenLevelsElem.textContent = vitals.oxygenLevels;
            temperatureElem.textContent = vitals.temperature;
            ecgStatusElem.textContent = vitals.ecgStatus;
             // Still check risk level to update the colored box if needed
            checkRiskLevel(vitals);
        }

        // --- Event Listeners ---
        simulateCrisisBtn.addEventListener('click', simulateMedicalCrisis);
        resetPatientBtn.addEventListener('click', resetSimulation);
        resetDoctorBtn.addEventListener('click', resetSimulation); // Doctor and Delivery resets use the same function
        resetDeliveryBtn.addEventListener('click', resetSimulation);

        // Initial tab load
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('patient');
        });
    </script>
</body>
</html>
